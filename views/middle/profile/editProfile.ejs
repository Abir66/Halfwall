<style>
input[type=text], select {
  width: 270px;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
input[type=date], select {
  width: 270px;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
input[type=email], select {
  width: 270px;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
input[type=number], select {
  width: 270px;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}


.form-group{
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: medium;
    background-color: transparent;
}
.container-edit{
    padding: 12px 12px 12px 12px;
}
.btn-block{
    width: 100%;
    margin-top: 15px;;
}
.hidden_message-edit{
    color : red;
}

</style>

<div class="post">
    <div class="container-edit">
        <h1>Edit Profile</h1>
        <form id="edit-form" > <!-- action="/user/editProfile" method="post" >  newsfee.js's /edit action="/newsfeed/editProfile" method="post" -->
            <div class="form-group"">
                <label for="name">Name</label>
                <input type="text" name="name" id="name" value="<%- currentUser.NAME %>">
            </div>
            <div class="form-group"">
                <label for="student_id">Student Id</label>
                <input type="number" name="student_id" id="student_id" value="<%- currentUser.STUDENT_ID %>">
            </div>
            <div class="form-group"">
                <label for="email">Email</label>
                <input type="email" name="email" id="email" value="<%- currentUser.EMAIL %>">
            </div>
            <div class="form-group"">
                <label for="dof">Date of Birth</label>
                <%let date = [null]; if(currentUser.DATE_OF_BIRTH !== null) {dates=currentUser.DATE_OF_BIRTH.toISOString(); date=dates.split('T');}%>
                <input type="date" name="dof" id="dof" value="<%= date[0]%>">
            </div>
            <div class="form-group"">
                <label for="hall">Hall</label>
                <select name="hall" id="hall">
                    <option value="" <% if(currentUser. HALL == ''){ %>selected<% } %> ></option>
                    <option value="Suhrawardy" <% if(currentUser.HALL == 'Suhrawardy'){ %>selected<% } %>  >Suhrawardy</option>
                    <option value="Sher e Bangla" <% if(currentUser.HALL == 'Sher e Bangla'){ %>selected<% } %> >Sher e Bangla</option>
                    <option value="Ahsanullah" <% if(currentUser.HALL == 'Ahsanullah'){ %>selected<% } %> >Ahsanullah</option>
                    <option value="Chattri" <% if(currentUser.HALL == 'Chattri'){ %>selected<% } %>>Chattri</option>
                    <option value="Kazi Nazrul" <% if(currentUser.HALL == 'Kazi Nazrul'){ %>selected<% } %>>Kazi Nazrul</option>
                    <option value="Titumir" <% if(currentUser.HALL == 'Titumir'){ %>selected<% } %>>Titumir</option>
                    <option value="Rashid" <% if(currentUser.HALL == 'Rashid'){ %>selected<% } %>>Rashid</option>
                </select>
            </div>
            <div class="form-group"">
                <label for="attachment">Attachment</label>
                <select name="attachment" id="attachment">
                    <option value="" <% if(currentUser. HALL_ATTACHMENT == ''){ %>selected<% } %> ></option>
                    <option value="R" <% if(currentUser. HALL_ATTACHMENT == 'R'){ %>selected<% } %> >Resident</option>
                    <option value="A" <% if(currentUser. HALL_ATTACHMENT == 'A'){ %>selected<% } %>>Attached</option> 
                </select>
            </div>
            <div class="form-group"">
                <label for="street">Street</label>
                <input type="text" name="street" id="street" value="<%- currentUser.STREET %> ">
            </div>
            <div class="form-group"">
                <label for="city">City</label>
                <input type="text" name="city" id="city"  value="<%- currentUser.CITY %>">
            </div>
            <div class="form-group"">
                <label for="postcode">Post Code</label>
                <input type="number" name="postcode" id="postcode" value="<%- currentUser.POSTCODE %>" >
            </div>
            <p class="hidden_message-edit" id="hidden_message"></p>
            <p id="userId" hidden ><%- currentUser.USER_ID %> </p> 
            <button id="editProfile" class="btn btn-primary btn-block" type="submit" name="submit">Save</button>
        </form>
        <% let tempUser = currentUser  %> 
    </div>
    <script>
        const edit = document.getElementById('editProfile');
        edit.addEventListener('click',function(e){
            e.preventDefault();
            editProfile();
        });
        let error_message = "";
        function check_inputs(email, studentId, name){
            if(email === '' || studentId === '' || name === ''){ 
                error_message = "* Email StudentId Name cannot Be of length zero"
                return false;
            }
            if(studentId.length != 7 || studentId.includes('.') || isNaN(studentId)){
                error_message = "* Invalid StudentId";
                return false;
            }
            if(!email.match(
                             /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
                )){
                error_message = "* Invalid Email Format";
                return false;
            }
            else return true;
        }
        async function editProfile(){
            const email = document.getElementById('email').value.replace(/ +(?= )/g,'').trim();
            const studentId = document.getElementById('student_id').value.replace(/ +(?= )/g,'');
            const name = document.getElementById('name').value.replace(/ +(?= )/g,'');
            const dof = document.getElementById('dof').value;
            const hall = document.getElementById('hall').value.replace(/ +(?= )/g,'').trim();
            const attachment = document.getElementById('attachment').value.replace(/ +(?= )/g,'').trim();
            const street = document.getElementById('street').value.replace(/ +(?= )/g,'').trim();
            const city = document.getElementById('city').value.replace(/ +(?= )/g,'').trim();
            const postcode = document.getElementById('postcode').value.replace(/ +(?= )/g,'').trim();

            const message = document.getElementById('hidden_message');

            const userId = document.getElementById('userId');

            console.log(email+"\n"+studentId+"\n"+name+"\n"+dof+"\n"+hall+"\n"+attachment+"\n"+street+"\n"+city+"\n"+postcode);
            
            

            if(!check_inputs(email, studentId, name)){
                message.innerHTML = error_message;
                message.setAttribute('visibility','visible');
                message.setAttribute('color','red');
                return;
            }

            const data = {
                student_id : studentId,
                email : email,
                name : name,
                dof : dof,
                hall : hall,
                attachment : attachment,
                street : street,
                city : city,
                postcode : postcode
            }
            const res = await axios.post("/user/editProfile", data);
            if(res.data === "success"){
                window.location.replace('/user/user_id='+parseInt(userId.innerHTML));
            }else{
                message.innerHTML = "* "+res.data;
                message.setAttribute('visibility','visible');
            }

        }
    </script>
</div>